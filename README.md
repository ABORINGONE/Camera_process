# 自动追踪摄像头云台项目

这是一个基于计算机视觉的自动追踪项目。它通过摄像头捕捉视频流，识别并锁定画面中的红色物体，然后通过蓝牙控制一个舵机云台，使其对准目标。当未检测到目标时，系统会自动进入巡航扫描模式。

## 功能特性

* **实时视频处理**: 通过 Wi-Fi 摄像头（例如 ESP32-CAM）获取实时视频流。
* **颜色识别与追踪**: 使用 OpenCV 库识别特定颜色（默认为红色）的物体，并计算其中心坐标。
* **多线程架构**: 将视频处理、蓝牙通信和云台控制逻辑分离到不同的线程中，保证程序运行的流畅性。
* **蓝牙串口通信**: 通过蓝牙串口（如 HC-06 模块）将控制指令发送给下位机（如 Arduino），以驱动舵机云台。
* **自动巡航扫描**: 在视野中没有检测到目标时，云台会自动进行左右扫描，扩大搜索范围。
* **参数化配置**: 所有的关键参数（如视频流地址、串口号、图像处理参数、舵机限位等）都在 `config.py` 文件中统一配置，方便修改和调试。

## 工作流程

1.  **视频处理线程 (`video_processor.py`)**:
    * 连接到指定的视频流 URL。
    * 逐帧读取视频图像，并将其旋转180度（可根据实际安装调整）。
    * 将图像从 BGR 色彩空间转换到 HSV 色彩空间，以便更准确地识别颜色。
    * 根据设定的阈值，创建一个只包含红色区域的二值化蒙版（mask）。
    * 通过形态学操作（开运算和闭运算）去除噪点，使目标轮廓更清晰。
    * 寻找蒙版中最大的轮廓，如果其面积大于设定的最小值，则计算其中心坐标。
    * 将计算出的中心坐标更新到所有线程共享的 `shared_state` 变量中。

2.  **中控线程 (`center_control.py`)**:
    * 持续从 `shared_state` 读取目标坐标。
    * **追踪模式**: 如果检测到目标坐标，计算目标与预设中心点（激光位置）的误差。根据误差调整云台的移动方向（`moving`）并决定是否开启激光（`firing`）。
    * **巡航模式**: 如果未检测到目标，控制云台进行左右往复扫描，并在扫描到边界时向下移动一定角度，实现全方位搜索。
    * 将更新后的云台移动指令和激光状态写回 `shared_state`。

3.  **蓝牙通信线程 (`bluetooth_communicator.py`)**:
    * 尝试连接到指定的蓝牙串口。如果连接断开，会自动尝试重连。
    * 周期性地从 `shared_state` 读取最新的云台移动指令和激光状态。
    * 将指令格式化为字符串（例如 `"x_move y_move firing_status"`），并通过串口发送出去。

4.  **主程序 (`main.py`)**:
    * 初始化一个用于线程间安全通信的共享字典 `shared_state` 和一个线程锁 `lock`。
    * 创建并启动上述三个线程。
    * 主线程保持运行，并监控子线程的状态。当用户按下 `ESC` 键关闭视频窗口或在终端按下 `Ctrl+C` 时，会安全地通知所有子线程停止并退出程序。

## 如何开始

### 硬件需求

* 一台运行 Python 的电脑
* 一个支持视频流的 Wi-Fi 摄像头（例如 ESP32-CAM）
* 一个蓝牙模块（例如 HC-06）连接到电脑
* 一个由单片机（如 Arduino）控制的舵机云台和激光模块

### 软件依赖

您需要安装以下 Python 库：

```bash
pip install opencv-python numpy pyserial requests
```

### 配置
在运行程序之前，请根据您的实际情况修改 config.py 文件：

* `VIDEO_STREAM_URL`: 设置您的摄像头的视频流地址。

* `SERIAL_PORT`: 设置您电脑上蓝牙模块对应的串口号（例如在 Windows 上是 COM21，在 Linux 上可能是 /dev/ttyUSB0）。

* `BAUD_RATE`: 确保波特率与您的蓝牙模块设置一致。

* `MIN_CONTOUR_AREA`, `FRAME_WIDTH`,` FRAME_HEIGHT` 等：根据需要调整图像处理相关的参数。

* `SERVO_X_MIN`, `SERVO_X_MAX` 等：设置舵机的运动范围限制，防止舵机卡死。

### 运行

直接在终端中运行主程序：

```bash
python main.py
```
程序启动后，您会看到两个窗口：一个显示原始的视频画面（`Video Feed`），另一个显示红色的二值化蒙版（`Red Mask`）。您可以在视频窗口激活的情况下按下 `ESC` 键，或在终端中按下 `Ctrl+C` 来停止程序。

## 文件结构

```bash
.
├── main.py                 # 主程序入口，负责启动和管理线程
├── config.py               # 配置文件，存储所有可调参数
├── video_processor.py      # 视频处理模块，负责目标检测和坐标计算
├── center_control.py       # 中心控制模块，负责云台运动和激光控制逻辑
├── bluetooth_communicator.py # 蓝牙通信模块，负责向上位机发送指令
└── .gitignore              # Git 忽略文件配置
```
